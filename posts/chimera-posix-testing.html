<!DOCTYPE html><html lang="en"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="theme-color" content="#66023C"><meta name="color-scheme" content="light dark"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><style type="text/css">:root{--footer-height:9rem;--content-width:40rem;--content-x-padding:1.5rem}h1{font-size:3rem;line-height:1.1}body{line-height:1.5;margin:0}#nav-body{min-height:calc(100svh - var(--footer-height))}main,nav,#footer-content{max-width:var(--content-width);margin:0 auto}main,nav{padding:1rem var(--content-x-padding)}nav a{font-size:smaller;text-decoration:none;font-weight:bold}nav ul,nav li{display:inline;margin-right:1em}footer{font-size:smaller;background:#66023C;color:white}#snail{max-width:50%;margin:0 auto;height:auto;display:block}#footer-content{height:var(--footer-height);padding:0 var(--content-x-padding);display:flex;align-items:center}pre code{overflow:auto}main{hyphens:auto}body{font-family:sans-serif}h1{hyphens:none}.aside,blockquote,pre code{padding:.5em}.aside{border-top:thin solid;border-bottom:thin solid;font-size:smaller}p:first-child{margin-top:0}p:last-child{margin-bottom:0}img{max-width:100%}sup{vertical-align:baseline;position:relative;top:-0.4em}blockquote,li,p{text-align:justify}span.published-date{font-size:smaller}code{font-style:normal;padding:.1em .2em;white-space:pre;font-family:monospace,monospace}pre code{border:thin solid;display:block;font-size:smaller}blockquote{margin:0;border-left:thin solid;font-style:oblique}ol,ul{margin-left:0;padding-left:0}#post-listing li{list-style-type:none}#skip{background:#66023C;color:white;padding:.3em;position:absolute;transform:translateY(-100%)}#skip:focus{transform:translateY(0%)}</style><title>Testing for POSIX compliance with Chimera Linux</title><script>window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',event=>document.documentElement.style["color-scheme"]=event.matches?"dark":"light");</script><div id="nav-body"><a href="#main" id="skip">Skip to content</a><nav><ul><li><a href="/index.html">snails.dev</a></ul></nav><main id="#main"><section id="Testing-for-POSIX-compliance-with-Chimera-Linux"><h1>Testing for POSIX compliance with Chimera Linux</h1><p><span class="published-date">2023-03-10</span><p>You might be aware that calling sed with <code>-i</code> option is a GNUism. Unix systems are described by the POSIX standard, which‚Äîuncharitably‚Äîis the lowest common denominator of what you can expect when you interact with a Unix box. Various Unix systems provide more than what POSIX specifies, through non-standard extensions. GNU userland, which is used by most‚Ä¶ linuces? linuxes? whatever‚Äîit has a shit ton of these extensions, <code>sed -i</code> being one of them.<p>Most of the time this is not a problem, but if you want to run a script full of these extensions on a different Unix, you‚Äôre gonna have a bad time. And how often is that? The other open source system family you might think about are BSDs. These are kinda niche, but there‚Äôs no need to make them even more niche by making lives of their users harder. But the system you probably thought about is macOS.<p>Yup, macOS is a Unix, and a certified one at that, and a lot of people in tech use it. <code>sed -i</code> won‚Äôt run there, at least not by default<sup>*</sup>. No POSIX command even accepts <code>--long-style-options</code>. It‚Äôd be difficult to enumerate all the GNUisms in a script and keep them in check by hand, and as far as I know there‚Äôs no tool to comprehensively<sup>‚Ä†</sup> check for that. Until now.<p>Enter the <a href="https://chimera-linux.org/">Chimera Linux distribution</a>. Long story short, Linux is the kernel, but the rest of the stack is LLVM, musl, and‚Äîmost importantly for this post‚ÄîFreeBSD userland. The project maintainers are even so kind to distribute it as a tarball of the file system. We are now one command away from creating an environment for testing our scripts for portability:<pre><code class="language-sh">docker image import chimera-linux-x86_64-ROOTFS-20221115-core.tar.gz chimera
</code></pre><p>This will create a docker image from the tarball and tag it <code>chimera</code>. You can now create a <code>chimera.Dockerfile</code> in your project, starting with the following line:<pre><code class="language-Dockerfile">FROM chimera
</code></pre><p>And you‚Äôre good to go. This is of course not a static analysis thing. You need to run your script inside the container. Errors might not come with nice messages and workaround suggestions, but it‚Äôs always something.<div class="aside"><p>* You can install GNU coreutils on a Mac.<p>‚Ä† ShellCheck is capable of catching some of these errors. Testing specifically for bashisms can be done with dash and posh shell‚Äîthe latter is specifically made for this. See <a href="https://people.redhat.com/~thuth/blog/general/2021/04/27/portable-shell.html">How to check your shell scripts for portability</a>.</div></section></main></div><footer><div id="footer-content"><div><p>This blog is powered by sed. And snails üêå<p>Gzipped with ‚ù§Ô∏è‚Äîhow else‚Äîdown to 3.0K</div></div></footer>
